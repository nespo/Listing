{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{% static 'profile/styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'tinymce/tinymce.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intl-tel-input.min.css"/>
{% endblock %}

{% block title %}Update Profile{% endblock %}
{% block content %}
<div class="profile-update-container">
    <h2>Update Profile</h2>
    <form method="post" enctype="multipart/form-data" class="profile-update-form" id="profile-update-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="profile-update-form-group">
            <label for="id_profile_image">Profile Image</label>
            {% if form.instance.profile_image %}
                <img src="{{ form.instance.profile_image.url }}" alt="Profile Image" class="profile-image-preview">
            {% endif %}
            {{ form.profile_image }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_company_name">Company Name</label>
            {{ form.company_name }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_company_phone_number">Company Phone Number</label>
            {{ form.company_phone_number }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_about">About</label>
            {{ form.about }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_country">Country</label>
            {{ form.country }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_state">State</label>
            {{ form.state }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_city">City</label>
            {{ form.city }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_company_address">Company Address</label>
            {{ form.company_address }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_first_name">First Name</label>
            {{ form.first_name }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_last_name">Last Name</label>
            {{ form.last_name }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_mobile_number">Mobile Number</label>
            {{ form.mobile_number }}
        </div>
        <div class="profile-update-form-group">
            <label for="id_bio">Bio</label>
            {{ form.bio }}
        </div>
        <button type="button" class="profile-update-btn" id="update-profile-btn">Update Profile</button>
    </form>
</div>

<div id="profile-update-success-modal" class="profile-update-modal">
    <div class="profile-update-modal-content">
        <span class="profile-update-modal-close" id="success-modal-close">&times;</span>
        <h2 id="modal-title"></h2>
        <p id="modal-message"></p>
    </div>
</div>

<div id="password-confirmation-modal" class="profile-update-modal">
    <div class="profile-update-modal-content">
        <span class="profile-update-modal-close">&times;</span>
        <h2>Confirm Password</h2>
        <form method="post" id="password-confirmation-form">
            {% csrf_token %}
            <div class="profile-update-form-group">
                <label for="id_password">Password</label>
                <input type="password" name="password" id="id_password" class="profile-update-form-control" required>
            </div>
            <button type="submit" class="profile-update-btn">Confirm</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize TinyMCE
        tinymce.init({
            selector: 'textarea',
            plugins: 'lists link',
            menubar: false,
            toolbar: 'bold italic underline | bullist numlist | link',
            height: 300,
            branding: false,
            forced_root_block: 'p',
            force_p_newlines: true,
            force_br_newlines: false,
            content_css: false,
            content_style: "body { font-family:Helvetica,Arial,sans-serif; font-size:14px }",
            valid_elements: 'p,b,strong,i,em,a[href],ul,ol,li',
            invalid_elements: 'script,iframe,object,embed'
        });

        // Initialize Choices.js
        const countrySelect = new Choices('#id_country', { searchEnabled: true });
        const stateSelect = new Choices('#id_state', { searchEnabled: true });
        const citySelect = new Choices('#id_city', { searchEnabled: true });

        // Load initial data from the form instance
        const initialCountryId = $('#id_country').val();
        const initialStateId = '{{ form.instance.state.id }}';
        const initialCityId = '{{ form.instance.city.id }}';

        if (initialStateId) {
            stateSelect.setChoiceByValue(initialStateId);
        }

        if (initialCityId) {
            citySelect.setChoiceByValue(initialCityId);
        }

        // Event handler for country change
        $('#id_country').change(function () {
            var countryId = $(this).val();
            $.ajax({
                url: `/api/get_states/${countryId}/`,
                success: function (data) {
                    stateSelect.clearStore();
                    stateSelect.setChoices(data.map(state => ({ value: state.id, label: state.name })), 'value', 'label', true);
                    stateSelect.setChoiceByValue('');

                    citySelect.clearStore();
                    citySelect.setChoices([], 'value', 'label', true);
                }
            });
        });

        // Event handler for state change
        $('#id_state').change(function () {
            var stateId = $(this).val();
            $.ajax({
                url: `/api/get_citiess/${stateId}/`,
                success: function (data) {
                    citySelect.clearStore();
                    citySelect.setChoices(data.map(city => ({ value: city.id, label: city.name })), 'value', 'label', true);
                    citySelect.setChoiceByValue('');
                }
            });
        });

        // Initialize intl-tel-input for phone number fields
        const phoneNumberFields = ['id_company_phone_number', 'id_mobile_number'];
        phoneNumberFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                const phoneInput = window.intlTelInput(field, {
                    initialCountry: "auto",
                    geoIpLookup: function(callback) {
                        fetch('https://ipinfo.io/json')
                            .then(response => response.json())
                            .then(data => callback(data.country))
                            .catch(() => callback('us'));
                    },
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                    nationalMode: false // Ensures that the phone number is formatted with the international dial code
                });

                // Set initial phone number value
                const initialPhoneNumber = field.value;
                if (initialPhoneNumber) {
                    phoneInput.setNumber(initialPhoneNumber);
                }

                field.addEventListener("countrychange", function () {
                    const countryData = phoneInput.getSelectedCountryData();
                    field.value = "+" + countryData.dialCode;
                });
            }
        });

        var successModal = document.getElementById("profile-update-success-modal");
        var passwordModal = document.getElementById("password-confirmation-modal");
        var closeBtns = document.getElementsByClassName("profile-update-modal-close");
        var modalTitle = document.getElementById("modal-title");
        var modalMessage = document.getElementById("modal-message");

        // Function to add z-index CSS
        function addZIndexCSS() {
            var style = document.createElement('style');
            style.id = 'tinymce-zindex-style';
            style.innerHTML = `
                .tox:not(.tox-tinymce-inline) .tox-editor-header:not(.tox-editor-dock-transition) {
                    z-index: 1 !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Function to remove z-index CSS
        function removeZIndexCSS() {
            var style = document.getElementById('tinymce-zindex-style');
            if (style) {
                style.remove();
            }
        }

        // Close modal on close button click
        for (var i = 0; i < closeBtns.length; i++) {
            closeBtns[i].onclick = function() {
                this.parentElement.parentElement.style.display = "none";
                removeZIndexCSS(); // Remove z-index CSS when modal is closed
                if (this.parentElement.parentElement == successModal && modalTitle.textContent !== "No Changes Detected") {
                    window.location.href = "{% url 'update_profile' %}";
                }
            }
        }

        // Close modal on window click
        window.onclick = function(event) {
            if (event.target == successModal || event.target == passwordModal) {
                event.target.style.display = "none";
                removeZIndexCSS(); // Remove z-index CSS when modal is closed
                if (event.target == successModal && modalTitle.textContent !== "No Changes Detected") {
                    window.location.href = "{% url 'update_profile' %}";
                }
            }
        }

        // Show password confirmation modal before updating profile
        document.getElementById('update-profile-btn').onclick = function() {
            passwordModal.style.display = "block";
            addZIndexCSS(); // Add z-index CSS when modal is opened
            passwordModal.classList.add('fade-in'); // Add animation class
        }

        // Handle password confirmation form submission
        document.getElementById('password-confirmation-form').onsubmit = function(event) {
            event.preventDefault();
            tinymce.triggerSave(); // Save TinyMCE content to the underlying textarea
            var password = document.getElementById('id_password').value;
            var formData = new FormData(document.getElementById('profile-update-form'));
            formData.append('password', password);
            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "update_profile" %}', true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('X-CSRFToken', csrfToken);

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 400) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        modalTitle.textContent = "Profile Updated";
                        modalMessage.textContent = response.message;
                        passwordModal.style.display = "none";
                        successModal.style.display = "block";
                    } else {
                        passwordModal.style.display = "none"; // Hide password modal on error
                        if (response.errors) {
                            var errors = response.errors;
                            for (var field in errors) {
                                var errorElement = document.getElementById('id_' + field).nextElementSibling;
                                if (errorElement) {
                                    errorElement.textContent = errors[field];
                                }
                            }
                        } else {
                            modalTitle.textContent = response.message;
                            modalMessage.textContent = "";
                            passwordModal.style.display = "none";
                            successModal.style.display = "block";
                        }
                    }
                } else {
                    console.error('An error occurred. Status:', xhr.status, 'Response:', xhr.responseText);
                }
            };

            xhr.onerror = function() {
                console.error('An error occurred during the request.');
            };

            xhr.send(formData);
        };

        // Ensure TinyMCE content is saved before form submission
        document.getElementById('profile-update-form').addEventListener('submit', function(event) {
            tinymce.triggerSave();
        });
    });
</script>
<style>
    .fade-in {
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
</style>
{% endblock %}
