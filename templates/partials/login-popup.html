{% load form_filters %}

{% if not user.is_authenticated %}
<div id="login-popup" class="popup">
    <div class="popup-content">
        <span class="close" id="close-login">&times;</span>
        <h2 class="heading-text-signup">Login</h2>
        <form id="login-form" method="post" action="{% url 'login_user' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="login_username">Username:*</label>
                <div class="input-icon">
                    <i class="fa fa-user"></i>
                    {{ login_form.username }}
                </div>
                <div class="error" id="error-login_username"></div>
            </div>
            <div class="form-group">
                <label for="login_password">Password:*</label>
                <div class="input-icon">
                    <i class="fa fa-lock"></i>
                    {{ login_form.password }}
                    <i class="fa fa-eye" id="toggle-login-password"></i>
                </div>
                <div class="error" id="error-login_password"></div>
            </div>
            <button type="submit">Login</button>
            <div class="error" id="error-login_form"></div>
        </form>
        <div class="popup-links">
            <a href="#" id="show-signup">Create Account</a> |
            <a href="#" id="show-reset">Forgot Password?</a>
        </div>
    </div>
</div>

<div id="signup-popup" class="popup">
    <div class="popup-content">
        <span class="close" id="close-signup">&times;</span>
        <div id="step-indicator">
            <span class="step active">1</span>
            <span class="step">2</span>
            <span class="step">3</span>
            <span class="step">4</span>
        </div>
        <form id="signup-form" method="post" action="{% url 'register_seller' %}">
            {% csrf_token %}
            <!-- Step 1 -->
            <div class="step-content active">
                <h2 class="heading-text-signup">Step 1: Account Information</h2>
                <div class="form-group">
                    <label for="signup_username">Username:*</label>
                    <div class="input-icon">
                        <i class="fa fa-user"></i>
                        {{ register_form.username }}
                    </div>
                    <div class="error" id="error-username"></div>
                </div>
                <div class="form-group">
                    <label for="signup_email">Email:*</label>
                    <div class="input-icon">
                        <i class="fa fa-envelope"></i>
                        {{ register_form.email }}
                    </div>
                    <div class="error" id="error-email"></div>
                </div>
                <button type="button" class="next-step">Next</button>
            </div>
            <!-- Step 2 -->
            <div class="step-content">
                <h2 class="heading-text-signup">Step 2: Personal Information</h2>
                <div class="form-group half-width">
                    <label for="signup_first_name">First Name:*</label>
                    <div class="input-icon">
                        <i class="fa fa-user"></i>
                        {{ register_form.first_name }}
                    </div>
                    <div class="error" id="error-first_name"></div>
                </div>
                <div class="form-group half-width">
                    <label for="signup_last_name">Last Name:*</label>
                    <div class="input-icon">
                        <i class="fa fa-user"></i>
                        {{ register_form.last_name }}
                    </div>
                    <div class="error" id="error-last_name"></div>
                </div>
                <div class="form-group half-width">
                    <label for="signup_mobile_number">Mobile Number:*</label>
                    {{ register_form.mobile_number }}
                    <div class="error" id="error-mobile_number"></div>
                </div>
                <div class="form-group half-width">
                    <label for="signup_password">Password:*</label>
                    <div class="input-icon">
                        <i class="fa fa-lock"></i>
                        {{ register_form.password }}
                        <i class="fa fa-eye" id="toggle-signup-password"></i>
                    </div>
                    <div class="error" id="error-password"></div>
                </div>
                <div class="form-group half-width">
                    <label for="signup_confirm_password">Confirm Password:*</label>
                    <div class="input-icon">
                        <i class="fa fa-lock"></i>
                        {{ register_form.confirm_password }}
                        <i class="fa fa-eye" id="toggle-signup-confirm-password"></i>
                    </div>
                    <div class="error" id="error-confirm_password"></div>
                </div>
                <button type="button" class="prev-step">Previous</button>
                <button type="button" class="next-step">Next</button>
            </div>
            <!-- Step 3 -->
            <div class="step-content">
                <h2 class="heading-text-signup">Step 3: Company Information</h2>
                <div class="form-group">
                    <label for="signup_company_name">Company Name:*</label>
                    <div class="input-icon">
                        <i class="fa fa-building"></i>
                        {{ register_form.company_name }}
                    </div>
                    <div class="error" id="error-company_name"></div>
                </div>
                <div class="form-group">
                    <label for="signup_company_address">Company Address:*</label>
                    <div class="input-icon">
                        <i class="fa fa-map-marker"></i>
                        {{ register_form.company_address }}
                    </div>
                    <div class="error" id="error-company_address"></div>
                </div>
                <div class="form-group">
                    <label for="signup_company_phone_number">Company Phone Number:*</label>
                    {{ register_form.company_phone_number }}
                    <div class="error" id="error-company_phone_number"></div>
                </div>
                <button type="button" class="prev-step">Previous</button>
                <button type="button" class="next-step">Next</button>
            </div>
            <!-- Step 4 -->
            <div class="step-content">
                <h2 class="heading-text-signup">Step 4: Location Information</h2>
                <div class="form-group">
                    <label for="signup_country">Country:*</label>
                    <div class="input-icon">
                        <i class="fa fa-globe"></i>
                        {{ register_form.country|add_class:"chosen-select" }}
                    </div>
                    <div class="error" id="error-country"></div>
                </div>
                <div class="form-group" id="state-group" style="display: none;">
                    <label for="signup_state">State:*</label>
                    <div class="input-icon">
                        <i class="fa fa-map"></i>
                        {{ register_form.state|add_class:"chosen-select" }}
                    </div>
                    <div class="error" id="error-state"></div>
                </div>
                <div class="form-group">
                    <label for="signup_city">City:*</label>
                    <div class="input-icon">
                        <i class="fa fa-city"></i>
                        {{ register_form.city }}
                    </div>
                    <div class="error" id="error-city"></div>
                </div>
                <button type="button" class="prev-step">Previous</button>
                <button type="submit" class="submit-btn">Submit</button>
            </div>
        </form>
        <div class="popup-links">
            <a href="#" id="show-login">Already have an account? Login</a>
        </div>
    </div>
</div>

<div id="reset-popup" class="popup">
    <div class="popup-content">
        <span class="close" id="close-reset">&times;</span>
        <h2 class="heading-text-signup">Reset Password</h2>
        <form id="reset-form" method="post" action="{% url 'password_reset' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="reset_email">Email:*</label>
                <div class="input-icon">
                    <i class="fa fa-envelope"></i>
                    <input type="email" name="email" id="reset_email" required>
                </div>
                <div class="error" id="error-reset_email"></div>
            </div>
            <button type="submit">Reset Password</button>
        </form>
        <div class="popup-links">
            <a href="#" id="show-login-from-reset">Back to Login</a>
        </div>
        <div id="reset-message" style="display:none;"></div>
    </div>
</div>
{% endif %}

{% block extra_js %}
<script>
window.addEventListener("load", function() {
    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed");

        const signupForm = document.getElementById("signup-form");
        const steps = document.querySelectorAll(".step-content");
        const stepIndicators = document.querySelectorAll("#step-indicator .step");
        const nextButtons = document.querySelectorAll(".next-step");
        const prevButtons = document.querySelectorAll(".prev-step");
        const submitButton = signupForm.querySelector("button[type='submit']");
        const loginPasswordField = document.querySelector("#login-form #id_password");
        const signupPasswordField = document.querySelector("#signup-form #id_password");
        const signupConfirmPasswordField = document.querySelector("#signup-form #id_confirm_password");
        const toggleLoginPassword = document.getElementById("toggle-login-password");
        const toggleSignupPassword = document.getElementById("toggle-signup-password");
        const toggleSignupConfirmPassword = document.getElementById("toggle-signup-confirm-password");

        let currentStep = 0;
        let isSubmitting = false; // Flag to prevent multiple submissions

        function showStep(step, direction = 'next') {
            steps.forEach((stepContent, index) => {
                stepContent.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                if (index === step) {
                    stepContent.style.display = 'block';
                    stepContent.classList.add(direction === 'next' ? 'slide-in-right' : 'slide-in-left');
                    // Initialize Choices for dynamically added select fields
                    new Choices('.chosen-select', { searchEnabled: true, itemSelectText: '' });
                } else {
                    stepContent.style.display = 'none';
                }
                stepIndicators[index].classList.toggle("active", index <= step);
            });
        }

        function validateStep(step, callback) {
            const formData = new FormData();

            steps.forEach((stepContent, index) => {
                if (index <= step) {
                    const inputs = stepContent.querySelectorAll("input, select");
                    inputs.forEach(input => {
                        formData.append(input.name, input.value);
                    });
                }
            });

            formData.append('step', step);
            formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);

            fetch("{% url 'validate_step' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    let valid = true;
                    if (data.errors) {
                        valid = false;
                        displayErrors(data.errors);
                    }
                    callback(valid);
                })
                .catch(error => {
                    console.error('An error occurred:', error);
                    callback(false);
                });
        }

        function displayErrors(errors) {
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
            for (let field in errors) {
                const errorElement = document.getElementById(`error-${field}`);
                if (errorElement) {
                    errorElement.textContent = errors[field];
                }
            }
        }

        nextButtons.forEach((button, index) => {
            button.addEventListener("click", function () {
                validateStep(currentStep, function (valid) {
                    if (valid) {
                        currentStep++;
                        showStep(currentStep, 'next');
                    }
                });
            });
        });

        prevButtons.forEach(button => {
            button.addEventListener("click", function () {
                currentStep--;
                showStep(currentStep, 'prev');
            });
        });

        signupForm.addEventListener("submit", function (event) {
            event.preventDefault();
            if (isSubmitting) return; // Prevent multiple submissions
            isSubmitting = true;
            submitButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Submitting...';

            validateStep(currentStep, function (valid) {
                if (valid) {
                    const formData = new FormData(signupForm);
                    fetch(signupForm.action, {
                        method: signupForm.method,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            isSubmitting = false; // Reset flag
                            if (data.success) {
                                signupPopup.style.display = "none";
                                signupForm.reset(); // Reset the form data
                                let messagesPopupContent = document.querySelector("#messages-popup .messages-container");
                                if (!messagesPopupContent) {
                                    messagesPopup.innerHTML = `
                                <div class="popup-content" style="
                                background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
                                border-radius: 15px;
                                padding: 20px;
                                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                                border: 1px solid #ccc;
                                backdrop-filter: blur(10px);
                                ">
                                <span class="close" id="close-messages" style="
                                    color: #aaa;
                                    float: right;
                                    font-size: 20px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    ">&times;</span>
                                <div class="messages-container" style="
                                    padding: 10px;
                                    background: #ffffff;
                                    border-radius: 10px;
                                    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
                                    ">
                                    <!-- Messages will be dynamically inserted here -->
                                </div>
                            </div>
                                `;
                                    messagesPopupContent = document.querySelector("#messages-popup .messages-container");
                                }
                                messagesPopupContent.innerHTML = `<div class="message success">We have sent you an Email. Please Verify Your Email.</div>`;
                                messagesPopup.style.display = "block";
                            } else {
                                displayErrors(data.errors);
                                submitButton.innerHTML = 'Submit'; // Reset button text
                            }
                        })
                        .catch(error => {
                            console.error('An error occurred:', error);
                            isSubmitting = false; // Reset flag
                            submitButton.innerHTML = 'Submit'; // Reset button text
                        });
                } else {
                    isSubmitting = false; // Reset flag
                    submitButton.innerHTML = 'Submit'; // Reset button text
                }
            });
        });

        showStep(currentStep);

        function togglePasswordVisibility(field) {
            console.log("Toggling password visibility");
            field.type = field.type === "password" ? "text" : "password";
        }

        if (toggleLoginPassword) {
            toggleLoginPassword.addEventListener("click", function () {
                togglePasswordVisibility(loginPasswordField);
                toggleLoginPassword.classList.toggle("fa-eye");
                toggleLoginPassword.classList.toggle("fa-eye-slash");
            });
        }

        if (toggleSignupPassword) {
            toggleSignupPassword.addEventListener("click", function () {
                togglePasswordVisibility(signupPasswordField);
                toggleSignupPassword.classList.toggle("fa-eye");
                toggleSignupPassword.classList.toggle("fa-eye-slash");
            });
        }

        if (toggleSignupConfirmPassword) {
            toggleSignupConfirmPassword.addEventListener("click", function () {
                togglePasswordVisibility(signupConfirmPasswordField);
                toggleSignupConfirmPassword.classList.toggle("fa-eye");
                toggleSignupConfirmPassword.classList.toggle("fa-eye-slash");
            });
        }

        // Format and validate phone number
        const phoneNumberFields = ['id_company_phone_number', 'id_mobile_number'];
        phoneNumberFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                const phoneInput = window.intlTelInput(field, {
                    initialCountry: "auto",
                    geoIpLookup: function (callback) {
                        fetch('https://ipinfo.io/json')
                            .then(response => response.json())
                            .then(data => callback(data.country))
                            .catch(() => callback('us'));
                    },
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                });

                field.addEventListener("countrychange", function () {
                    const countryData = phoneInput.getSelectedCountryData();
                    field.value = "+" + countryData.dialCode;
                });
            }
        });

        // Handle country, state, and city fields
        const countryField = document.getElementById('id_country');
        const stateField = document.getElementById('id_state');
        const cityField = document.getElementById('id_city');
        const stateGroup = document.getElementById('state-group');

        // Function to toggle the state field visibility and required attribute
        function toggleStateField() {
            const selectedCountry = countryField.value;
            if (selectedCountry === '39' || selectedCountry === '230') {  // Assuming these are the country IDs for US and Canada
                stateGroup.style.display = 'block';
                stateField.required = true;
            } else {
                stateGroup.style.display = 'none';
                stateField.required = false;
            }
        }

        if (countryField) {
            countryField.addEventListener('change', function () {
                const countryId = this.value;
                toggleStateField();
                if (countryId) {
                    fetch(`/api/get_states/${countryId}/`)
                        .then(response => response.json())
                        .then(data => {
                            stateField.innerHTML = '';
                            const defaultOption = document.createElement('option');
                            defaultOption.textContent = 'Select State';
                            defaultOption.value = '';
                            stateField.appendChild(defaultOption);

                            data.forEach(state => {
                                const option = document.createElement('option');
                                option.value = state.id;
                                option.textContent = state.name;
                                stateField.appendChild(option);
                            });

                            new Choices('.chosen-select', { searchEnabled: true, itemSelectText: '' }); // Update Choices
                        });
                }
            });
        }

        toggleStateField(); // Initial call to set the correct state of the state field

        // Toggle dropdown content visibility
        const accountIcon = document.getElementById("account-icon");
        const dropdownContent = document.getElementById("dropdown-content");
        const loginPopup = document.getElementById("login-popup");
        const signupPopup = document.getElementById("signup-popup");
        const resetPopup = document.getElementById("reset-popup");
        const messagesPopup = document.getElementById("messages-popup");
        const closeLogin = document.getElementById("close-login");
        const closeSignup = document.getElementById("close-signup");
        const closeReset = document.getElementById("close-reset");
        const closeMessages = document.getElementById("close-messages");
        const loginLink = document.getElementById("login");
        const signupLink = document.getElementById("signup");
        const showSignup = document.getElementById("show-signup");
        const showLogin = document.getElementById("show-login");
        const showReset = document.getElementById("show-reset");
        const showLoginFromReset = document.getElementById("show-login-from-reset");
        const mobileLoginLink = document.getElementById("mobile-login");
        const mobileSignupLink = document.getElementById("mobile-signup");

        accountIcon.addEventListener("click", function (event) {
            dropdownContent.style.display = dropdownContent.style.display === "block" ? "none" : "block";
            event.stopPropagation();
        });

        window.addEventListener("click", function (event) {
            if (!event.target.closest("#account-icon") && !event.target.closest("#dropdown-content")) {
                dropdownContent.style.display = "none";
            }
        });

        if (loginLink) {
            loginLink.addEventListener("click", function () {
                loginPopup.style.display = "block";
                dropdownContent.style.display = "none";
            });
        }

        if (signupLink) {
            signupLink.addEventListener("click", function () {
                signupPopup.style.display = "block";
                dropdownContent.style.display = "none";
            });
        }

        if (showSignup) {
            showSignup.addEventListener("click", function () {
                signupPopup.style.display = "block";
                loginPopup.style.display = "none";
            });
        }

        if (showLogin) {
            showLogin.addEventListener("click", function () {
                loginPopup.style.display = "block";
                signupPopup.style.display = "none";
            });
        }

        if (showReset) {
            showReset.addEventListener("click", function () {
                resetPopup.style.display = "block";
                loginPopup.style.display = "none";
            });
        }

        if (showLoginFromReset) {
            showLoginFromReset.addEventListener("click", function () {
                loginPopup.style.display = "block";
                resetPopup.style.display = "none";
            });
        }

        if (closeLogin) {
            closeLogin.addEventListener("click", function () {
                loginPopup.style.display = "none";
            });
        }

        if (closeSignup) {
            closeSignup.addEventListener("click", function () {
                signupPopup.style.display = "none";
            });
        }

        if (closeReset) {
            closeReset.addEventListener("click", function () {
                resetPopup.style.display = "none";
            });
        }

        if (closeMessages) {
            closeMessages.addEventListener("click", function () {
                messagesPopup.style.display = "none";
            });
        }

        if (mobileLoginLink) {
            mobileLoginLink.addEventListener("click", function () {
                loginPopup.style.display = "block";
                mobileMenu.style.left = "-100%";
                hamburgerIcon.style.display = "block";
                closeIcon.style.display = "none";
            });
        }

        if (mobileSignupLink) {
            mobileSignupLink.addEventListener("click", function () {
                signupPopup.style.display = "block";
                mobileMenu.style.left = "-100%";
                hamburgerIcon.style.display = "block";
                closeIcon.style.display = "none";
            });
        }

        const hamburgerIcon = document.getElementById("hamburger-icon");
        const closeIcon = document.getElementById("close-icon");
        const mobileMenu = document.getElementById("mobile-menu");

        hamburgerIcon.addEventListener("click", function () {
            console.log("Hamburger icon clicked");
            mobileMenu.style.left = "0";
            hamburgerIcon.style.display = "none";
            closeIcon.style.display = "block";
        });

        closeIcon.addEventListener("click", function () {
            console.log("Close icon clicked");
            mobileMenu.style.left = "-100%";
            hamburgerIcon.style.display = "block";
            closeIcon.style.display = "none";
        });

        const loginForm = document.getElementById("login-popup")?.querySelector("form");
        const resetForm = document.getElementById("reset-form");

        if (loginForm) {
            loginForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(loginForm);
                fetch(loginForm.action, {
                    method: loginForm.method,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/dashboard';
                        } else {
                            const formErrorDiv = document.getElementById('error-login_form');
                            formErrorDiv.textContent = data.errors.form;
                            formErrorDiv.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        const formErrorDiv = document.getElementById('error-login_form');
                        formErrorDiv.textContent = 'An error occurred while trying to log in. Please try again.';
                        formErrorDiv.style.display = 'block';
                    });
            });
        }

        if (resetForm) {
            resetForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(resetForm);
                fetch(resetForm.action, {
                    method: resetForm.method,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        const resetMessage = document.getElementById("reset-message");
                        if (data.message) {
                            resetMessage.style.display = "block";
                            resetMessage.textContent = data.message;
                            resetMessage.className = 'message success';
                            setTimeout(() => {
                                resetMessage.style.display = "none";
                                document.getElementById("reset-popup").style.display = "none";
                            }, 5000);
                        } else if (data.error) {
                            resetMessage.style.display = "block";
                            resetMessage.textContent = data.error;
                            resetMessage.className = 'message error';
                            setTimeout(() => {
                                resetMessage.style.display = "none";
                            }, 5000);
                        }
                    })
                    .catch(error => console.error('An error occurred:', error));
            });
        }
    });
});
</script>
{% endblock %}
