{% extends "base.html" %}
{% load static %}
{% load humanize %} <!-- Ensure humanize is loaded -->

{% block title %}Search Listing{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'alllisting/styles.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>Find Your Ideal Project</h1>
    <p>Use the search filters below to find the projects that match your criteria.</p>
</div>
<div class="search-filters">
    <select id="country" placeholder="Country">
        <option value="">Country</option>
        {% for country in countries %}
            <option value="{{ country.name }}" {% if request.GET.country == country.name %}selected{% endif %}>
                {{ country.name }}
            </option>
        {% endfor %}
    </select>
    
    <select id="category" placeholder="Project Type">
        <option value="">Project Type</option>
        {% for category in categories %}
            <option value="{{ category.name }}" {% if request.GET.categories and category.name in request.GET.categories %}selected{% endif %}>
                {{ category.name }}
            </option>
        {% endfor %}
    </select>    
    <input type="number" id="min_price" placeholder="Min Price">
    <input type="number" id="max_price" placeholder="Max Price">
    <select id="sort_by">
        <option value=""> Sort By</option>
        <option value="date_newest">Date (Newest)</option>
        <option value="date_oldest">Date (Oldest)</option>
        <option value="price_low_to_high">Price (Low to High)</option>
        <option value="price_high_to_low">Price (High to Low)</option>
        <option value="update_time">Update Time</option>
    </select>    
</div>
<div class="total-results floating">
    Total Results: <span id="total-results">{{ listings.count }}</span>
</div>
<div class="container">
    <div class="map-section">
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>
    <div class="listings-section" id="listings">
        {% include 'partials/listings.html' %}        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include jQuery and jQuery UI library -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var map;
        var markers = [];
        var listingsData = JSON.parse(document.getElementById('listings-data').textContent);
        //console.log('listingsData:', listingsData);

        // Initialize Choices.js for the select elements
        var countrySelect = new Choices('#country');
        var categorySelect = new Choices('#category');
        var sortBySelect = new Choices('#sort_by', { removeItemButton: true });

        // Function to set field values from URL
        function setFieldValuesFromUrl() {
            const params = new URLSearchParams(window.location.search);

            // Set values for country field
            if (params.has('location')) {
                countrySelect.setChoiceByValue(params.get('location'));
            }

            // Set values for category field
            if (params.has('categories[]')) {
                const categories = params.getAll('categories[]');
                categories.forEach(category => {
                    categorySelect.setChoiceByValue(category);
                });
            }

            // Set values for min and max price fields
            if (params.has('price_min')) {
                document.getElementById('min_price').value = params.get('price_min');
            }
            if (params.has('price_max')) {
                document.getElementById('max_price').value = params.get('price_max');
            }

            // Set values for sort by field
            if (params.has('sort_by')) {
                sortBySelect.setChoiceByValue(params.get('sort_by'));
            }
        }

        function initMap() {
            map = L.map('map').setView([51.505, -0.09], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            updateMarkers(listingsData);
        }

        function updateMarkers(listings) {
            console.log('updateMarkers called with:', listings);

            if (!Array.isArray(listings)) {
                console.error('Listings data is not an array:', listings);
                return;
            }

            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            listings.forEach(listing => {
                if (listing.latitude && listing.longitude) {
                    addMarker(listing.latitude, listing.longitude, listing.project_name, listing.id);
                } else if (listing.project_city) {
                    fetchCoordinatesAndAddMarker(listing.project_city, listing.project_name, listing.id);
                }
            });
        }

        function addMarker(lat, lon, projectName, listingId) {
            var marker = L.marker([lat, lon]).addTo(map).bindPopup(projectName);
            markers.push(marker);

            marker.on('click', function() {
                scrollToListing(listingId);
            });
        }

        function fetchCoordinatesAndAddMarker(city, projectName, listingId) {
            $.ajax({
                url: `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`,
                success: function(data) {
                    if (data && data.length > 0) {
                        var lat = data[0].lat;
                        var lon = data[0].lon;
                        addMarker(lat, lon, projectName, listingId);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Geocoding request failed:", status, error);
                }
            });
        }

        function scrollToListing(id) {
            var listingElement = document.getElementById('listing-' + id);
            if (listingElement) {
                $('.listing-box').removeClass('highlighted');
                listingElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                listingElement.classList.add('highlighted');
            }
        }

        function fetchListings() {
            var country = $('#country').val();
            var category = $('#category').val();
            var min_price = $('#min_price').val();
            var max_price = $('#max_price').val();
            var sort_by = sortBySelect.getValue().value; // Get value using Choices.js API

            $.ajax({
                url: '{% url "all_listings" %}',
                data: {
                    'country': country,
                    'categories[]': category,
                    'min_price': min_price,
                    'max_price': max_price,
                    'sort_by': sort_by
                },
                success: function(response) {
                    console.log('AJAX success response:', response);
                    $('#listings').html(response.html);
                    $('#total-results').text(response.total_results);

                    try {
                        var listings = JSON.parse(response.listings);
                        if (Array.isArray(listings)) {
                            updateMarkers(listings);
                        } else {
                            console.error('Listings data is not an array after parsing:', listings);
                        }
                    } catch (e) {
                        console.error('Error parsing listings data:', e);
                    }
                },
                error: function(xhr, status, error) {
                    console.log("AJAX request failed:");
                    console.log("Status:", status);
                    console.log("Error:", error);
                }
            });
        }

        $('#country, #category, #min_price, #max_price, #sort_by').on('change', function(e) {
            if (this.id === 'sort_by') {
                sort_by = sortBySelect.getValue().value; // Update on change using Choices.js API
            }
            fetchListings();
        });

        initMap();
        setFieldValuesFromUrl(); // Ensure values are set after Choices.js initialization
    });
</script>
<script id="listings-data" type="application/json">
    {{ listings_data|safe }}
</script>
{% endblock %}
